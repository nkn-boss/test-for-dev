@isTest
public class QueueableStoreInfoSyncWithYextTest {
    @isTest static void testStoreInfoSynchronization() {
        String jsonString = '{"meta":{"uuid":"017ef66e-b01a-a893-407d-c41bc4c266c7","errors":[]},"response":{"entities":[{"googlePlaceId":"wewewe","savedFilters":["3217","3221"],"address":{"line1":"Ennis Shopping Centre","line2":"Francis Street","city":"Ennis","region":"Clare","postalCode":"V95 C62F","countryCode":"IE"},"addressHidden":false,"hours":{"monday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"tuesday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"wednesday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"thursday":{"openIntervals":[{"start":"09:00","end":"21:00"}]},"friday":{"openIntervals":[{"start":"09:00","end":"21:00"}]},"saturday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"sunday":{"openIntervals":[{"start":"11:00","end":"18:00"}]},"holidayHours":[{"date":"2022-12-25","isClosed":true},{"date":"2022-12-26","openIntervals":[{"start":"10:00","end":"16:00"}]}]},"name":"Penneys","cityCoordinate":{"latitude":52.8474255,"longitude":-8.988738399999999},"closed":false,"c_areagroupname":"Ireland","c_areaname":"Michael McCarthy","c_cTAButtonCopy1":"Penneys Customer Service","c_cTAButtonCopy1DataLayer":"Customer Service","c_cTAButtonURL1":"https://www.help.Test.com/hc/en-gb/requests/new","c_customPaymentOptions":["ME2YOU_VOUCHER","ONE4ALL_VOUCHER"],"c_fAQPagesSectionCTA":{"copy":"READ MORE","url":"https://www.Test.com/en-ie/the-edit/home/covid-19-faqs/a/be6dc8ce-6469-42a2-8cd3-3ddc7a5125b5","copyDataLayer":"READ MORE"},"c_geomodifier":"Ennis Shopping Centre","c_liveOnPages":true,"c_locationPageMetaDescription":"Find your Amazing at Penneys Ennis Shopping Centre in Ennis. Browse opening hours, get directions and plan your trip to your local Penneys today.","c_locationPageMetaTitle":"Penneys Ennis Shopping Centre: Amazing Fashion, Amazing Prices in Ennis","c_pageType":"Store Page","c_pagesBusinessDescription":"test","c_pagesInStoreDepartments":["Womens Clothing","Mens Clothing","Kids Clothing","Beauty Skincare and Cosmetics","Homeware","Accessories","Footwear","Nightwear and Hosiery","Luggage and Travel Accessories","Confectionery"],"c_pagesServices":["TAXFREESHOPPING","PARKINGFACILITIES","FREEWIFIAVAILABLE","WHEELCHAIR_ACCESS"],"c_pagesStoreExperiences":[{"image":{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/2084x1350.jpg","alternateText":"Penneys Autism Awareness","width":2084,"height":1350,"thumbnails":[{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/2084x1350.jpg","width":2084,"height":1350},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/1900x1231.jpg","width":1900,"height":1231},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/619x401.jpg","width":619,"height":401},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/600x389.jpg","width":600,"height":389},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/196x127.jpg","width":196,"height":127}]},"title":"Penneys Autism Friendly Shopping Experience","description":"Were teaming up with Ireland’s national autism charity, AsIAm to become more autism-friendly. On November 14th, we introduced sensory friendly shopping in all stores across Ireland for the first hours of opening every Sunday. This will provide a more inclusive shopping experience for our autistic customers and colleagues, with the security of knowing that additional assistance is available when needed.","ctaCopy":"READ MORE","ctaUrl":"https://www.Test.com/en-ie/autismfriendly","cTACopyDataLayer":"READ MORE"}],"c_pagesURL":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","c_parkingInformation":[{"title":"Euro Car Park","copy":"Tesco Shopping Centre, Francis Street, Ennis, County Clare"}],"c_sensoryOverloadList":{"title":"Sensory Overloads","list":["Shopping Center Entrance"]},"facebookCoverPhoto":{"url":"https://a.mktgcdn.com/p/WnoGeYjrzNW0VEOfpwrYgnlB4ss8XGMRmMnZKeoCQYI/851x315.jpg","width":851,"height":315},"facebookDescriptor":"Ennis, V95 C62F","facebookPageUrl":"https://www.facebook.com/148609522483641","facebookParentPageId":"171392586242801","facebookProfilePhoto":{"url":"http://a.mktgcdn.com/p/f5DrdlBJ3u4m5nUrHXjqoz8zahzgBtIsyLsFq2pI8vA/320x320.jpg","width":320,"height":320,"thumbnails":[{"url":"http://a.mktgcdn.com/p/f5DrdlBJ3u4m5nUrHXjqoz8zahzgBtIsyLsFq2pI8vA/196x196.jpg","width":196,"height":196}]},"facebookStoreId":"14","featuredMessage":{"description":"Click Here To Shop","url":"http://www.Test.com/"},"geocodedCoordinate":{"latitude":52.8455484,"longitude":-8.9762},"googleAccountId":"108642349796383064007","googleCoverPhoto":{"url":"http://a.mktgcdn.com/p/VB8iSxgoc1B_eAq1YuirQPwzz1WpS6RSk2J4caLngDM/851x478.jpg","width":851,"height":478},"googleProfilePhoto":{"url":"https://a.mktgcdn.com/p/ZlyhxOLMQRpiUokBBKlBZibeH7x16kVdoE6yQex2xaY/768x768.jpg","width":768,"height":768,"thumbnails":[{"url":"https://a.mktgcdn.com/p/ZlyhxOLMQRpiUokBBKlBZibeH7x16kVdoE6yQex2xaY/500x500.jpg","width":500,"height":500}]},"isoRegionCode":"CE","mainPhone":"+353656829921","menuUrl":{"preferDisplayUrl":false},"orderUrl":{"preferDisplayUrl":false},"paymentOptions":["AMERICANEXPRESS","ANDROIDPAY","APPLEPAY","CASH","MASTERCARD","VISA"],"rankTrackingCompetitors":[{"name":"H\u0026M","website":"https://www2.hm.com/en_ie/index.html"},{"name":"Zara","website":"https://www.zara.com/ie/"},{"name":"River Island","website":"https://www.riverisland.ie/"},{"name":"Next","website":"https://www.next.ie/en"},{"name":"Dunnes Stores","website":"https://www.dunnesstores.com/"}],"customKeywords":["pyjamas","loungewear","shorts","swimwear","sandals"],"rankTrackingEnabled":true,"rankTrackingFrequency":"WEEKLY","rankTrackingQueryTemplates":["KEYWORD_CITY","KEYWORD_IN_CITY","KEYWORD_NEAR_ME","KEYWORD_CITY_STATE"],"rankTrackingSites":["GOOGLE_DESKTOP","GOOGLE_MOBILE","BING_DESKTOP","BING_MOBILE","YAHOO_DESKTOP","YAHOO_MOBILE"],"reservationUrl":{"preferDisplayUrl":false},"timezone":"Europe/Dublin","websiteUrl":{"url":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","displayUrl":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","preferDisplayUrl":false},"yextDisplayCoordinate":{"latitude":52.84553355076761,"longitude":-8.976200653748606},"yextRoutableCoordinate":{"latitude":52.845904254157546,"longitude":-8.976868093013763},"yextWalkableCoordinate":{"latitude":52.84581353691952,"longitude":-8.976634740829468},"meta":{"accountId":"1546350","uid":"grao03","id":"14","timestamp":"2022-01-25T10:14:31","labels":["32730","35305","31914","55658","71698","115766","115762","115761","152596"],"folderId":"384104","schemaTypes":["ClothingStore"],"language":"en_GB","countryCode":"IE","entityType":"location"},"googleAttributes":[{"id":"requires_masks_customers","values":["true"]}],"categoryIds":["1341528","263"],"timeZoneUtcOffset":"+00:00"}],"count":410,"pageToken":""}}';
        
        HttpMock mock = new HttpMock(200,'SUCCESS',jsonString, new Map<String,String>(), true);        
        Test.setMock(HttpCalloutMock.class, mock);
        
        Test.startTest();
        System.enqueueJob(new QueueableStoreInfoSyncWithYext());
        Test.stopTest();
        
        List<Account> storeLocationRecords = [Select Id, Name, Address_Line_1__c, Display_Hours__c, Phone, Monday_Hours__c, Tuesday_Hours__c, Wednesday_Hours__c, Thursday_Hours__c, Friday_Hours__c, Saturday_Hours__c, Sunday_Hours__c FROM Account];
        System.assertEquals(1, storeLocationRecords.size(),'Store location size is 1');
        System.assertEquals('Penneys', storeLocationRecords[0].name,'Store location is Penneys');
        System.assertEquals('Ennis Shopping Centre', storeLocationRecords[0].Address_Line_1__c,'Store location AddressLine');
        System.assertEquals('+353656829921', storeLocationRecordS[0].Phone,'Store location Phone');
        System.assertEquals('Monday 09:00 - 18:00', storeLocationRecords[0].Monday_Hours__c,'Store location MondayHours');
        System.assertEquals('Tuesday 09:00 - 18:00', storeLocationRecords[0].Tuesday_Hours__c,'Store location TuesdayHours');
        System.assertEquals('Wednesday 09:00 - 18:00', storeLocationRecords[0].Wednesday_Hours__c,'Store location WednesdayHours');
        System.assertEquals('Thursday 09:00 - 21:00', storeLocationRecords[0].Thursday_Hours__c,'Store location ThursdayHours');
        System.assertEquals('Friday 09:00 - 21:00', storeLocationRecords[0].Friday_Hours__c,'Store location FridayHours');
        System.assertEquals('Saturday 09:00 - 18:00', storeLocationRecords[0].Saturday_Hours__c,'Store location SaturdayHours');
        System.assertEquals('Sunday 11:00 - 18:00', storeLocationRecords[0].Sunday_Hours__c,'Store location SundayHours');
    }
    
    @isTest static void testStoreInfoSynchronizationWithCalloutException() {
        String jsonString = '{"meta":{"uuid":"017ef66e-b01a-a893-407d-c41bc4c266c7","errors":[]},"response":{"entities":[{"googlePlaceId":"wewewe","savedFilters":["3217","3221"],"address":{"line1":"Ennis Shopping Centre","line2":"Francis Street","city":"Ennis","region":"Clare","postalCode":"V95 C62F","countryCode":"IE"},"addressHidden":false,"hours":{"tuesday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"wednesday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"thursday":{"openIntervals":[{"start":"09:00","end":"21:00"}]},"friday":{"openIntervals":[{"start":"09:00","end":"21:00"}]},"saturday":{"openIntervals":[{"start":"09:00","end":"18:00"}]},"sunday":{"openIntervals":[{"start":"11:00","end":"18:00"}]},"holidayHours":[{"date":"2022-12-25","isClosed":true},{"date":"2022-12-26","openIntervals":[{"start":"10:00","end":"16:00"}]}]},"name":"Penneys","cityCoordinate":{"latitude":52.8474255,"longitude":-8.988738399999999},"closed":false,"c_areagroupname":"Ireland","c_areaname":"Michael McCarthy","c_cTAButtonCopy1":"Penneys Customer Service","c_cTAButtonCopy1DataLayer":"Customer Service","c_cTAButtonURL1":"https://www.help.Test.com/hc/en-gb/requests/new","c_customPaymentOptions":["ME2YOU_VOUCHER","ONE4ALL_VOUCHER"],"c_fAQPagesSectionCTA":{"copy":"READ MORE","url":"https://www.Test.com/en-ie/the-edit/home/covid-19-faqs/a/be6dc8ce-6469-42a2-8cd3-3ddc7a5125b5","copyDataLayer":"READ MORE"},"c_geomodifier":"Ennis Shopping Centre","c_liveOnPages":true,"c_locationPageMetaDescription":"Find your Amazing at Penneys Ennis Shopping Centre in Ennis. Browse opening hours, get directions and plan your trip to your local Penneys today.","c_locationPageMetaTitle":"Penneys Ennis Shopping Centre: Amazing Fashion, Amazing Prices in Ennis","c_pageType":"Store Page","c_pagesBusinessDescription":"test","c_pagesInStoreDepartments":["Womens Clothing","Mens Clothing","Kids Clothing","Beauty Skincare and Cosmetics","Homeware","Accessories","Footwear","Nightwear and Hosiery","Luggage and Travel Accessories","Confectionery"],"c_pagesServices":["TAXFREESHOPPING","PARKINGFACILITIES","FREEWIFIAVAILABLE","WHEELCHAIR_ACCESS"],"c_pagesStoreExperiences":[{"image":{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/2084x1350.jpg","alternateText":"Penneys Autism Awareness","width":2084,"height":1350,"thumbnails":[{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/2084x1350.jpg","width":2084,"height":1350},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/1900x1231.jpg","width":1900,"height":1231},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/619x401.jpg","width":619,"height":401},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/600x389.jpg","width":600,"height":389},{"url":"https://a.mktgcdn.com/p/lHB3ZLFQ0_mwnkHXaXrS70Up0mqLH37psyFFIaOBG_0/196x127.jpg","width":196,"height":127}]},"title":"Penneys Autism Friendly Shopping Experience","description":"Were teaming up with Ireland’s national autism charity, AsIAm to become more autism-friendly. On November 14th, we introduced sensory friendly shopping in all stores across Ireland for the first hours of opening every Sunday. This will provide a more inclusive shopping experience for our autistic customers and colleagues, with the security of knowing that additional assistance is available when needed.","ctaCopy":"READ MORE","ctaUrl":"https://www.Test.com/en-ie/autismfriendly","cTACopyDataLayer":"READ MORE"}],"c_pagesURL":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","c_parkingInformation":[{"title":"Euro Car Park","copy":"Tesco Shopping Centre, Francis Street, Ennis, County Clare"}],"c_sensoryOverloadList":{"title":"Sensory Overloads","list":["Shopping Center Entrance"]},"facebookCoverPhoto":{"url":"https://a.mktgcdn.com/p/WnoGeYjrzNW0VEOfpwrYgnlB4ss8XGMRmMnZKeoCQYI/851x315.jpg","width":851,"height":315},"facebookDescriptor":"Ennis, V95 C62F","facebookPageUrl":"https://www.facebook.com/148609522483641","facebookParentPageId":"171392586242801","facebookProfilePhoto":{"url":"http://a.mktgcdn.com/p/f5DrdlBJ3u4m5nUrHXjqoz8zahzgBtIsyLsFq2pI8vA/320x320.jpg","width":320,"height":320,"thumbnails":[{"url":"http://a.mktgcdn.com/p/f5DrdlBJ3u4m5nUrHXjqoz8zahzgBtIsyLsFq2pI8vA/196x196.jpg","width":196,"height":196}]},"facebookStoreId":"14","featuredMessage":{"description":"Click Here To Shop","url":"http://www.Test.com/"},"geocodedCoordinate":{"latitude":52.8455484,"longitude":-8.9762},"googleAccountId":"108642349796383064007","googleCoverPhoto":{"url":"http://a.mktgcdn.com/p/VB8iSxgoc1B_eAq1YuirQPwzz1WpS6RSk2J4caLngDM/851x478.jpg","width":851,"height":478},"googleProfilePhoto":{"url":"https://a.mktgcdn.com/p/ZlyhxOLMQRpiUokBBKlBZibeH7x16kVdoE6yQex2xaY/768x768.jpg","width":768,"height":768,"thumbnails":[{"url":"https://a.mktgcdn.com/p/ZlyhxOLMQRpiUokBBKlBZibeH7x16kVdoE6yQex2xaY/500x500.jpg","width":500,"height":500}]},"isoRegionCode":"CE","mainPhone":"+353656829921","menuUrl":{"preferDisplayUrl":false},"orderUrl":{"preferDisplayUrl":false},"paymentOptions":["AMERICANEXPRESS","ANDROIDPAY","APPLEPAY","CASH","MASTERCARD","VISA"],"rankTrackingCompetitors":[{"name":"H\u0026M","website":"https://www2.hm.com/en_ie/index.html"},{"name":"Zara","website":"https://www.zara.com/ie/"},{"name":"River Island","website":"https://www.riverisland.ie/"},{"name":"Next","website":"https://www.next.ie/en"},{"name":"Dunnes Stores","website":"https://www.dunnesstores.com/"}],"customKeywords":["pyjamas","loungewear","shorts","swimwear","sandals"],"rankTrackingEnabled":true,"rankTrackingFrequency":"WEEKLY","rankTrackingQueryTemplates":["KEYWORD_CITY","KEYWORD_IN_CITY","KEYWORD_NEAR_ME","KEYWORD_CITY_STATE"],"rankTrackingSites":["GOOGLE_DESKTOP","GOOGLE_MOBILE","BING_DESKTOP","BING_MOBILE","YAHOO_DESKTOP","YAHOO_MOBILE"],"reservationUrl":{"preferDisplayUrl":false},"timezone":"Europe/Dublin","websiteUrl":{"url":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","displayUrl":"https://stores.Test.com/ireland/ennis/ennis-shopping-centre","preferDisplayUrl":false},"yextDisplayCoordinate":{"latitude":52.84553355076761,"longitude":-8.976200653748606},"yextRoutableCoordinate":{"latitude":52.845904254157546,"longitude":-8.976868093013763},"yextWalkableCoordinate":{"latitude":52.84581353691952,"longitude":-8.976634740829468},"meta":{"accountId":"1546350","uid":"grao03","id":"14","timestamp":"2022-01-25T10:14:31","labels":["32730","35305","31914","55658","71698","115766","115762","115761","152596"],"folderId":"384104","schemaTypes":["ClothingStore"],"language":"en_GB","countryCode":"IE","entityType":"location"},"googleAttributes":[{"id":"requires_masks_customers","values":["true"]}],"categoryIds":["1341528","263"],"timeZoneUtcOffset":"+00:00"}],"count":410,"pageToken":""}}';
        String exceptionMessage = 'Unauthorized endpoint, please check Setup->Security->Remote site settings.';
        
        HttpMock mock = new HttpMock(404,'ERROR',jsonString, new Map<String,String>(), false);        
        Test.setMock(HttpCalloutMock.class, mock);
        
        Test.startTest();
        System.enqueueJob(new QueueableStoreInfoSyncWithYext());
        Test.stopTest();
        
        List<CustomException__c> customExceptionRecords = [Select Id, Exception_message__c From CustomException__c];
        System.assertEquals(exceptionMessage, customExceptionRecords[0].Exception_Message__c,'Exception Message');
        System.assertEquals(1, customExceptionRecords.size(),'Size is 1');
    }
    
    @isTest static void testStoreInfoSynchronizationWithInvalidResponseException() {
        String jsonResponse = 'invalid Response';
        String exceptionMessage = 'Unexpected character';
        
        HttpMock mock = new HttpMock(200,'SUCCESS',jsonResponse, new Map<String,String>(), true);        
        Test.setMock(HttpCalloutMock.class, mock);
        
        Test.startTest();
        System.enqueueJob(new QueueableStoreInfoSyncWithYext());
        Test.stopTest();
        
        List<CustomException__c> customExceptionRecords = [Select Id, Exception_message__c From CustomException__c];
        System.assertEquals(true, customExceptionRecords[0].Exception_Message__c.contains(exceptionMessage),'Exception Message');
        System.assertEquals(1, customExceptionRecords.size(),'Size is 1');
    }
}